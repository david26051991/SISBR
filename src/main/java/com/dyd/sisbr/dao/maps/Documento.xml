<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.dyd.sisbr.dao.DocumentoDAO">  	
  
  	<resultMap id="documento" type="com.dyd.sisbr.model.Documento">
		<result property="idDocumento" 		column="idDocumento"/>
		<result property="idClase" 			column="idClase"/>
		<result property="titulo" 			column="titulo"/>
		<result property="nombre" 			column="nombre"/>
		<result property="clase.idClase" 	column="idClase"/>
		<result property="clase.nombre"		column="nombreclase"/>
	</resultMap>
	
  	<insert id="insertDocumento" useGeneratedKeys="true" keyProperty="idDocumento">
        INSERT INTO documento(idClase, titulo, nombre, idArchivo) VALUES(#{idClase},#{titulo},#{nombre}, #{idArchivo})
    </insert> 
     
	<select id="selectAllDocumento" resultMap="documento">
		SELECT d.idDocumento, d.idClase, d.titulo, d.nombre, c.nombre as nombreclase, d.idArchivo
		FROM documento d INNER JOIN clase c ON d.idClase = c.idClase
	</select>
	
	<select id="selectDocumentos" resultMap="documento">
		SELECT idDocumento, idClase, titulo, nombre, idArchivo
		FROM documento 
		<where>
			<if test="idDocumento != 0" > idDocumento = #{idDocumento} </if>
			<if test="idClase != 0" > idClase = #{idClase} </if>
			<if test="anioIni != 0" > AND anio <![CDATA[>=]]>  #{anioIni} </if>
			<if test="anioFin != 0" > AND anio <![CDATA[<=]]> #{anioFin} </if>
			<if test="nombre != null" > AND UPPER(nombre) = UPPER(#{nombre}) </if>
		</where>
	</select>
	
	<select id="selectDocumentoByID" resultMap="documento">
		SELECT idDocumento, idClase, titulo, nombre
		FROM documento 
		WHERE idDocumento = #{idDocumento}
	</select>
	
	<select id="selectCantidadDocumentosTotal" resultType="java.lang.Integer">
		SELECT count(idDocumento) AS cantidad FROM documento
	</select>
    
    <update id="updateDocumento">
    	UPDATE documento
    	<set>
	      <if test="titulo != null">titulo = #{titulo},</if>
	      <if test="nombre != null">nombre = #{nombre},</if>
	      <if test="idClase != null">idClase = #{idClase},</if>
	      <if test="anio != 0">anio = #{anio},</if>
	      <if test="mes != 0">mes = #{mes}</if>
	    </set>
    	WHERE
    		idDocumento = #{idDocumento}
	</update>
	
	<select id="selectCantidadDocumentos" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CONCAT(anio, '-', RIGHT(CONCAT('00',mes),2)) AS fecha, count(idDocumento) AS cantidad
		FROM documento
		WHERE idClase = #{idClase} 
		AND DATEFROMPARTS(anio, mes, 1) <![CDATA[>=]]> DATEFROMPARTS(#{anioIni}, #{mesIni}, 1)
		AND DATEFROMPARTS(anio, mes, 1) <![CDATA[<=]]> DATEFROMPARTS(#{anioFin}, #{mesFin}, 1)
		GROUP BY anio, mes
	</select>
	
  </mapper>
   